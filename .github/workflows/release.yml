name: Semantic Release

on:
  push:
    branches:
      - main

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    concurrency: release
    environment: pypi
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Python Semantic Release
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          # Ensure we are on the branch, not detached HEAD
          git checkout main
          
          # 1. Bump version, update changelog, commit, tag, and build (via 'uv build')
          uvx --from python-semantic-release==10.5.3 semantic-release version
          
          # 2. Push the version bump commit and tag back to the repo
          git push origin main --follow-tags
          
          # 3. Upload to GitHub Releases
          uvx --from python-semantic-release==10.5.3 semantic-release publish

          # 3. Check if a build artifact was created (implies a release occurred)
          if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
             echo "released=true" >> $GITHUB_OUTPUT
          fi

      - name: Publish to PyPI
        if: steps.release.outputs.released == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
